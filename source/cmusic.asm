;cmusic.asm
;plays themes!

;play_music()
;plays an SID file
_MUSIC
	JSR _PTMUSIC
	LDA #$D0
	STA V_MUSTMR

	SEI
	LDA #<@IRQ
	LDX #>@IRQ
	STA INT_ADDR
	STX INT_ADDR+1
	LDA #$1B
	LDX #$00
	LDY #$7F 
	STA $D011
	STX $D012
	STY $DC0D
	LDA #$01
	STA $D01A
	STA $D019 ; ACK ANY RASTER IRQS
	LDA #$00
	LDX #$00
	JSR _PTMUSIC ;placeholder!!!
	CLI
@HOLD         
	JMP @HOLD ;WE DON'T WANT TO DO ANYTHING ELSE HERE. :)
	; WE COULD ALSO RTS HERE, WHEN ALSO CHANGING $EA81 TO $EA31
@IRQ
	LDA #$01
	STA $D019 ; ACK ANY RASTER IRQS
	LDX #$03
	JSR _PTMUSIC ;placeholder!!!
	
	DEC V_MUSTMR
	LDA V_MUSTMR
	BEQ @DONE
	JMP $EA31
@DONE
	JSR _GX_ECM
	LDA #<INTERRUPT
	STA INT_ADDR
	LDA #>INTERRUPT
	STA INT_ADDR+1
	
	LDA #$00
	STA $D01A
	PLA
	PLA
	PLA
	PLA
	PLA
	PLA
	RTS
	
_PTMUSIC
	LDA V_PARTY
	BEQ @DEM
	CMP #$01
	BEQ @REP
	CMP #$03
	BEQ @SOC
	LDA S_PLAYER
	CMP #$04
	BEQ @PAT
	LDA S_3PMODE
	BEQ @IND
@SOC
	+__LAB2XY D_MUSS
	JMP @NEXT
@IND
	+__LAB2XY D_MUSI
	JMP @NEXT
@PAT
	+__LAB2XY D_MUSP
	JMP @NEXT
@REP
	+__LAB2XY D_MUSR
	JMP @NEXT
@DEM
	+__LAB2XY D_MUSD
@NEXT
	;SELF-MODIFYING CODE: changes _MUSIC to play the chosen label
	STX _MUSIC+47
	STY _MUSIC+48
	
	TXA
	CLC
	ADC #$03
	TAX
	BCC @CARRY
	INY
@CARRY
	
	STX _MUSIC+61
	STY _MUSIC+62
	
	RTS
	
	
